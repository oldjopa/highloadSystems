@startuml
' Диаграмма ER базы данных для сайта продажи самолетов
left to right direction
hide circle
skinparam linetype ortho
skinparam classAttributeIconSize 0

entity "Пользователь" as User {
  *id : Long
  --
  email : varchar(320) <<UNIQUE>>
  phone : varchar(32)? <<UNIQUE>>
  hashed_password : varchar
  first_name : varchar(100)
  last_name : varchar(100)
  created_at : timestamp
  updated_at : timestamp
}

entity "Роль пользователя" as Role {
  *name : varchar(50)
  --
  level : int
  description : text?
}

entity "Тип самолета" as AircraftEquipment {
  * id : Long
  --
  manufacturer : varchar(100)
  model : varchar(100)
  variant : varchar(100)?
  description : text?
  engine_count : int
  engine_id : int FK
  max_seats : int
  max_takeoff_weight_kg : int
  range_km : int
  cruise_speed_knots : int
  pressurized : boolean
}

entity "Двигатель" as Engine {
    *id : Long
    --
    name : varchar
    type : enum('piston','turboprop','jet','electric','other')
    power : Float
}

entity "Доп функция" as Feature {
    *id : Long
    --
    name : varchar
}

entity "Самолет" as Aircraft {
  *id : Long
  --
  type_id : Long FK
  tech_passport_id : Long FK
  owner_id : Long
  serial_number : varchar(100) <<UNIQUE>>
  registration_number : varchar(50)? <<UNIQUE>>
  listed_price : numeric(15,2)?
  currency : char(3)?
  created_at : timestamp
  updated_at : timestamp
}

entity "Техпаспорт самолета" as TechPassport {
  *id : Long
  --
  flight_hours : numeric(10,1)
  manufacture_year : int
  empty_weight_kg : int?
  fuel_capacity_l : int?
  length_m : decimal(5,2)?
  wingspan_m : decimal(5,2)?
  height_m : decimal(5,2)?
  noise_cert : varchar(100)?
  created_at : timestamp
  updated_at : timestamp
}

entity "Техпаспорт-фича" as TechPassportFeature {
    tech_passport_id : int FK
    feature_id : int FK
}

entity "Сделка" as Deal {
  *id : Long
  --
  deal_number : varchar(50) <<UNIQUE>>
  aircraft_id : Long
  buyer_id : Long
  seller_id : Long
  status_code : varchar(30)
  is_active : boolean
  created_at : timestamp
  updated_at : timestamp
  closed_at : timestamp?
}

entity "Статус сделки" as DealStatus {
  *code : varchar(30)
  --
  name : varchar(100)
  description : text?
  order_index : int
  is_terminal : boolean
}

entity "История статусов сделки" as DealStatusHistory {
  *id : Long
  --
  deal_id : Long
  status_code : varchar(30)
  changed_by : Long
  changed_at : timestamp
  comment : text?
}

' Связи
AircraftEquipment ||--o{ Aircraft : тип
TechPassport }o-|| TechPassportFeature
TechPassportFeature ||-o{ Feature
AircraftEquipment ||--o{ Engine

User ||--o{ Aircraft : владелец

Aircraft ||--o{ Deal : предмет
User ||--o{ Deal : продавец
User ||--o{ Deal : покупатель

DealStatus ||--o{ Deal : статус
Deal ||--o{ DealStatusHistory : история
DealStatus ||--o{ DealStatusHistory : статус
User ||--o{ DealStatusHistory : изменил

' 1:0..1 техпаспорт к самолету
Aircraft ||--o| TechPassport : техпаспорт
User }o--o{ Role : роль

@enduml